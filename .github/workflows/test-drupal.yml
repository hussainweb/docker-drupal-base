name: Test Drupal Installation

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  test-apache-frankenphp:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php_version: ["8.4", "8.5"]
        variant: ["apache-trixie", "frankenphp-trixie"]
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build \
            --build-arg PHP_VERSION=${{ matrix.php_version }} \
            -t drupal-test:${{ matrix.php_version }}-${{ matrix.variant }} \
            ./php8/${{ matrix.variant }}

      - name: Run test container
        run: |
          WEB_ROOT=/var/www/html
          if [ "${{ matrix.variant }}" = "frankenphp-trixie" ]; then
            WEB_ROOT=/app
          fi
          echo "WEB_ROOT=${WEB_ROOT}" >> $GITHUB_ENV

          PORT=8080
          echo "PORT=${PORT}" >> $GITHUB_ENV

          CONTAINER_NAME=test-container
          echo "CONTAINER_NAME=${CONTAINER_NAME}" >> $GITHUB_ENV

          docker run -d -p $PORT:80 --name $CONTAINER_NAME drupal-test:${{ matrix.php_version }}-${{ matrix.variant }}

      - name: Install dependencies
        run: |
          sleep 10
          docker exec ${{ env.CONTAINER_NAME }} sh -c "apt-get update && apt-get install -y --no-install-recommends git curl unzip rsync"

      - name: Install Drupal
        run: |
          docker exec --workdir ${{ env.WEB_ROOT }} ${{ env.CONTAINER_NAME }} sh -c "composer create-project drupal/recommended-project drupal_project --no-interaction && rsync -a drupal_project/ . && rm -rf drupal_project"
          docker exec --workdir ${{ env.WEB_ROOT }} ${{ env.CONTAINER_NAME }} sh -c "composer require drush/drush"

      - name: Enable PHP error display for debugging
        run: |
          PHP_INI_PATH=$(docker exec ${{ env.CONTAINER_NAME }} php -i | grep "Loaded Configuration File" | cut -d' ' -f5)
          docker exec ${{ env.CONTAINER_NAME }} sh -c "sed -i 's/display_errors = Off/display_errors = On/g' $PHP_INI_PATH"
          docker exec ${{ env.CONTAINER_NAME }} sh -c "sed -i 's/error_reporting = E_ALL & ~E_DEPRECATED & ~E_STRICT/error_reporting = E_ALL/g' $PHP_INI_PATH"

      - name: Configure Apache
        if: matrix.variant == 'apache-trixie'
        run: |
          docker exec ${{ env.CONTAINER_NAME }} a2enmod rewrite
          docker exec ${{ env.CONTAINER_NAME }} apache2ctl -k graceful

      - name: Install Drupal site
        run: |
          docker exec --workdir ${{ env.WEB_ROOT }}/web ${{ env.CONTAINER_NAME }} sh -c "../vendor/bin/drush site-install standard --db-url=sqlite://sites/default/files/.ht.sqlite --site-name='Test' -y"

          if [ "${{ matrix.variant }}" = "apache-trixie" ]; then
            docker exec ${{ env.CONTAINER_NAME }} chown -R www-data:www-data ${{ env.WEB_ROOT }}
          fi

          sleep 10

      - name: Verify Drupal installation
        run: curl -v --fail http://localhost:${{ env.PORT }}

      - name: Show logs on failure
        if: failure()
        run: |
          echo "::group::File permissions on sites/default"
          docker exec ${{ env.CONTAINER_NAME }} ls -la ${{ env.WEB_ROOT }}/web/sites/default
          echo "::endgroup::"
          echo "::group::Docker logs"
          docker logs ${{ env.CONTAINER_NAME }}
          echo "::endgroup::"
          if [ "${{ matrix.variant }}" = "apache-trixie" ]; then
            echo "::group::Apache error log"
            docker exec ${{ env.CONTAINER_NAME }} cat /var/log/apache2/error.log
            echo "::endgroup::"
          fi

  test-fpm:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php_version: ["8.4", "8.5"]
        variant: ["fpm-alpine"]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Compose
        uses: docker/setup-compose-action@v1

      - name: Create docker-compose for testing
        run: |
          cat <<EOF > docker-compose.test.yml
          services:
            php-fpm:
              build:
                context: ./php8/fpm-alpine
                args:
                  PHP_VERSION: ${{ matrix.php_version }}
              container_name: php-fpm
              volumes:
                - drupal-code:/var/www/html
            nginx:
              image: nginx:alpine
              container_name: nginx
              ports:
                - "8080:80"
              volumes:
                - drupal-code:/var/www/html
                - ./nginx.conf:/etc/nginx/conf.d/default.conf
          volumes:
            drupal-code:
          EOF

      - name: Create nginx config
        run: |
          cat <<EOF > nginx.conf
          server {
              listen 80;
              server_name localhost;
              root /var/www/html/web;
              index index.php;

              location / {
                  try_files \$uri /index.php?\$query_string;
              }

              location ~ \.php$ {
                  fastcgi_pass php-fpm:9000;
                  fastcgi_index index.php;
                  include fastcgi_params;
                  fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
              }
          }
          EOF

      - name: Start services
        run: docker compose -f docker-compose.test.yml up -d --build

      - name: Install Drupal
        run: |
          sleep 10
          docker exec php-fpm sh -c "apk add --no-cache git curl unzip"
          docker exec --workdir /var/www/html php-fpm sh -c "composer create-project drupal/recommended-project . --no-interaction"
          docker exec --workdir /var/www/html php-fpm sh -c "composer require drush/drush"
          docker exec php-fpm chown -R www-data:www-data /var/www/html

      - name: Enable PHP error display for debugging
        run: |
          PHP_INI_PATH=$(docker exec php-fpm php -i | grep "Loaded Configuration File" | cut -d' ' -f5)
          docker exec php-fpm sh -c "sed -i 's/display_errors = Off/display_errors = On/g' $PHP_INI_PATH"
          docker exec php-fpm sh -c "sed -i 's/error_reporting = E_ALL & ~E_DEPRECATED & ~E_STRICT/error_reporting = E_ALL/g' $PHP_INI_PATH"
          docker exec php-fpm kill -USR2 1
          sleep 5

      - name: Install Drupal site
        run: |
          docker exec --workdir /var/www/html/web php-fpm sh -c "../vendor/bin/drush site-install standard --db-url=sqlite://sites/default/files/.ht.sqlite --site-name='Test' -y"
          docker exec php-fpm chown -R www-data:www-data /var/www/html/web/sites
          sleep 10

      - name: Verify Drupal installation
        run: curl -v --fail http://localhost:8080

      - name: Show logs on failure
        if: failure()
        run: |
          echo "::group::File permissions on sites/default"
          docker exec php-fpm ls -la /var/www/html/web/sites/default
          echo "::endgroup::"
          echo "::group::Nginx container logs"
          docker logs nginx
          echo "::endgroup::"
          echo "::group::Nginx error log"
          docker exec nginx cat /var/log/nginx/error.log
          echo "::endgroup::"
          echo "::group::PHP-FPM container logs"
          docker logs php-fpm
          echo "::endgroup::"

      - name: Stop services
        if: always()
        run: docker compose -f docker-compose.test.yml down --volumes
