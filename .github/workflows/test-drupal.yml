name: Test Drupal Installation

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  test-apache-frankenphp:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php_version: ["8.4", "8.5"]
        variant: ["apache-trixie", "frankenphp-trixie"]
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build \
            --build-arg PHP_VERSION=${{ matrix.php_version }} \
            -t drupal-test:${{ matrix.php_version }}-${{ matrix.variant }} \
            ./php8/${{ matrix.variant }}

      - name: Test Drupal Installation
        run: |
          WEB_ROOT=/var/www/html
          if [ "${{ matrix.variant }}" = "frankenphp-trixie" ]; then
            WEB_ROOT=/app
          fi

          PORT=8080
          CONTAINER_NAME=test-container

          docker run -d -p $PORT:80 --name $CONTAINER_NAME drupal-test:${{ matrix.php_version }}-${{ matrix.variant }}
          sleep 10

          docker exec $CONTAINER_NAME sh -c "apt-get update && apt-get install -y --no-install-recommends git curl unzip"

          docker exec --workdir $WEB_ROOT $CONTAINER_NAME sh -c "composer create-project drupal/recommended-project . --no-interaction"
          docker exec --workdir $WEB_ROOT $CONTAINER_NAME sh -c "composer require drush/drush"

          if [ "${{ matrix.variant }}" = "apache-trixie" ]; then
            docker exec $CONTAINER_NAME a2enmod rewrite
            docker exec $CONTAINER_NAME service apache2 restart
          fi

          docker exec --workdir $WEB_ROOT/web $CONTAINER_NAME sh -c "../vendor/bin/drush site-install standard --db-url=sqlite://sites/default/files/.ht.sqlite --site-name='Test' -y"

          sleep 10
          # Use curl to check for a successful installation
          curl -sI http://localhost:$PORT | grep "HTTP/1.1 200 OK"

  test-fpm:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php_version: ["8.4", "8.5"]
        variant: ["fpm-alpine"]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Compose
        uses: docker/setup-compose-action@v1

      - name: Create docker-compose for testing
        run: |
          cat <<EOF > docker-compose.test.yml
          services:
            php-fpm:
              build:
                context: ./php8/fpm-alpine
                args:
                  PHP_VERSION: ${{ matrix.php_version }}
              container_name: php-fpm
              volumes:
                - drupal-code:/var/www/html
            nginx:
              image: nginx:alpine
              container_name: nginx
              ports:
                - "8080:80"
              volumes:
                - drupal-code:/var/www/html
                - ./nginx.conf:/etc/nginx/conf.d/default.conf
          volumes:
            drupal-code:
          EOF

      - name: Create nginx config
        run: |
          cat <<EOF > nginx.conf
          server {
              listen 80;
              server_name localhost;
              root /var/www/html/web;
              index index.php;

              location / {
                  try_files \$uri /index.php?\$query_string;
              }

              location ~ \.php$ {
                  fastcgi_pass php-fpm:9000;
                  fastcgi_index index.php;
                  include fastcgi_params;
                  fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
              }
          }
          EOF

      - name: Start services
        run: docker compose -f docker-compose.test.yml up -d --build

      - name: Test Drupal Installation
        run: |
          sleep 10
          docker exec php-fpm sh -c "apk add --no-cache git curl unzip"
          docker exec --workdir /var/www/html php-fpm sh -c "composer create-project drupal/recommended-project . --no-interaction"
          docker exec --workdir /var/www/html php-fpm sh -c "composer require drush/drush"
          docker exec --workdir /var/www/html/web php-fpm sh -c "../vendor/bin/drush site-install standard --db-url=sqlite://sites/default/files/.ht.sqlite --site-name='Test' -y"

          sleep 10
          curl -sI http://localhost:8080 | grep "HTTP/1.1 200 OK"

      - name: Stop services
        if: always()
        run: docker compose -f docker-compose.test.yml down --volumes
